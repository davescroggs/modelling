---
title: "Expected Homers!"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

https://www.kaggle.com/competitions/nwds-xhr/data

```{r}
library(tidyverse)
library(tidymodels)
library(skimr)
library(scales)
library(here)

set.seed(2023)
# Kaggle API download
# kaggle competitions download -c nwds-xhr

homers_data <- read_csv(here("data/nwds-xhr/train.csv")) %>% 
  mutate(is_hr = if_else(is_hr == 1, "homer", "no_homer") %>% factor)

homers_split <- initial_split(homers_data)

test <- testing(homers_split)
train <- training(homers_split)

theme_set(theme_bw() +
            theme(plot.title = element_text(hjust = 0.5),
                  plot.subtitle = element_text(hjust = 0.5)))
```

## Skim

Take a quick look at the training data and identify things like columns with missing data and the proportion

Column type frequency:           
  character                7     
  logical                  3     
  numeric                  24

```{r}
(homers_skim <- skim(train))
```


## EDA

### Categorical features

- home_team
- pitch_type
- stand
- p_throws
- inning_topbot
- if_fielding_alignment
- of_fielding_alignment


First create a summary function to provide summary statistics for home runs by group.
```{r}

homers_summarise <- function(df){
  df %>% 
    summarise(n_homer = sum(is_hr == "homer"),
              n = n(),
              .groups = "drop") %>% 
    arrange(desc(n)) %>% 
    mutate(pct_hr = n_homer/n,
           low = qbeta(.025, n_homer + 0.5, n - n_homer + 0.5),
           high = qbeta(.975, n_homer + 0.5, n - n_homer + 0.5))
}

homer_plot <- function(df, col) {
  df %>% 
    group_by({{col}}) %>% 
    homers_summarise() %>% 
    mutate("{{col}}" := fct_reorder({{col}}, pct_hr)) %>% 
    ggplot(aes(x = pct_hr, y = {{col}})) +
    geom_point(aes(size = n)) +
    geom_errorbar(aes(xmin = low, xmax = high), width = 0.6, linewidth = 0.3) +
    labs(x = "% home runs") +
    scale_x_continuous(labels = percent)
}

```

#### Home team

```{r}
train %>% 
  homer_plot(home_team)
```


### pitch_type

```{r}
train %>% 
  mutate(pitch_type = fct_lump_prop(pitch_type, 0.01)) %>% 
  homer_plot(pitch_type)
```

### stand

```{r}
train %>% 
  homer_plot(stand)
```

### p_throws

```{r}
train %>% 
  homer_plot(p_throws)
```
### inning_topbot

```{r}
train %>% 
  homer_plot(inning_topbot)
```

### if_fielding_alignment

```{r}
train %>% 
  homer_plot(if_fielding_alignment)
```


### of_fielding_alignment

```{r}
train %>% 
  homer_plot(of_fielding_alignment)
```


### innings

```{r}
train %>% 
  filter(inning < 10) %>% 
  mutate(inning = if_else(inning_topbot == "Top", inning + 0.5, inning) %>% factor) %>% 
  homer_plot(inning)
```

### Numeric features

```{r}
train %>% 
select(sz_top, sz_bot, release_pos_x, release_pos_y, release_pos_z, inning, outs_when_up, balls, strikes, pitch_number, at_bat_number, release_speed, spin_axis, release_spin_rate, pfx_x, pfx_z, plate_x, plate_z, hc_x, hc_y, launch_speed, launch_angle, is_hr) %>% 
  pivot_longer(cols = -is_hr) %>% 
  group_by(name) %>%
  yardstick::roc_auc(truth = is_hr, value, event_level = "second") %>% 
  arrange(desc(.estimate)) %>%
  mutate(name = fct_reorder(name, .estimate)) %>%
  ggplot(aes(.estimate, name)) +
  geom_point() +
  geom_vline(xintercept = .5) +
  labs(x = "AUC",
       y = "Variable",
       title = "ROC AUC of numeric variables",
       subtitle = ".5 is not predictive at all; <.5 means negatively associated with stikes, >.5 means positively associated")
```

